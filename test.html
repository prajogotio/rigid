<html>
<head>
	<script src="rigid.js"></script>
</head>
<body>
	<canvas id="canvas" width="1000" height="600" >
	</canvas>
	<script>
	var canvas = document.getElementById('canvas');
	var g = canvas.getContext('2d');
	g.lineWidth = 3;
	function draw(b) {
		g.beginPath();
		g.strokeStyle = "black";
		if (b instanceof Sphere) {
			g.beginPath();
			g.arc(b.cm.x, b.cm.y, b.radius, 0, 2*Math.PI);
			g.stroke();

			g.beginPath();
			g.moveTo(b.cm.x, b.cm.y);
			var end = b.cm.plus(b.getAbsoluteDirection(new Vec2(1,0)).times(b.radius));
			g.lineTo(end.x, end.y);
			g.stroke();
			return;
		}
		g.moveTo(b.getAbsolutePosition(b.v[0]).x, b.getAbsolutePosition(b.v[0]).y);
		for (var i = 1; i < b.v.length;++i) {
			g.lineTo(b.getAbsolutePosition(b.v[i]).x, b.getAbsolutePosition(b.v[i]).y);
		}
		g.closePath();
		g.stroke();
	}

	function drawDirection(n) {
		g.save();
		g.strokeStyle = "red"
		g.translate(300, 300);
		g.fillRect(0,0,4,4);
		g.beginPath();
		g.moveTo(0,0);
		g.lineTo(n.x*100, n.y*100);
		g.stroke();
		g.restore();
	}

	function drawEdge(edge) {
		g.strokeStyle = "#1fa";
		g.beginPath();
		g.moveTo(edge[0].x, edge[0].y);
		g.lineTo(edge[1].x, edge[1].y);
		g.stroke();
		g.restore();
	}

	function drawContactPoint(pt) {
		g.fillStyle = "red";
		g.fillRect(pt.x, pt.y, 6, 6);
	}

	function drawCollision() {
		g.fillRect(0,0,8,8);
	}

	function test() {
		var A = new Body(new Vec2(30, 30), [new Vec2(-50,-50),
					  new Vec2(-50,50),
					  new Vec2(50,50),
					  new Vec2(50,-50)],
					  35,
					  0.5,
					  100,
					  new Vec2(1, 2),
					  null,
					  0.3);
		var B = new Body(new Vec2(230, 230), [new Vec2(0,70),
					  new Vec2(100,0),
					  new Vec2(-44,0)],
					  40,
					  0.8,
					  100,
					  new Vec2(0, 0));
		var t = setInterval(function() {
			g.clearRect(0,0,canvas,600);
			draw(A);
			draw(B);
			var n = A.axisOfLeastSeparationWith(B).axis;
			
			if (A.collidesWith(B)) {
				drawCollision();
			}

			drawDirection(n);

			var ref = A.getBestContactEdge(n);
			var inc = B.getBestContactEdge(n.flip());

			drawEdge(ref);
			drawEdge(inc);

			var contacts = getContactPoints(ref, inc);
			for (var i = 0; i < contacts.length; ++i) {
				drawContactPoint(contacts[i]);
			}
		}, 1000/60);
		addEventListener("keydown", function(e){
			if (e.which == 13) {
				clearInterval(t);
			} else if (e.which == 38) {
				A.cm.y -= 5;
			} else if (e.which == 40) {
				A.cm.y += 5;
			} else if (e.which == 37) {
				A.cm.x -= 5;
			} else if (e.which == 39) {
				A.cm.x += 5;
			}
		});
	}

	function testCollision() {
		var A = new Body(new Vec2(30, 30), [new Vec2(-50,-50),
					  new Vec2(-50,50),
					  new Vec2(50,50),
					  new Vec2(50,-50)],
					  35,
					  0.5,
					  100,
					  new Vec2(1, 2),
					  null,
					  Math.PI/1200);
		var B = new Body(new Vec2(230, 230), [new Vec2(0,70),
					  new Vec2(100,0),
					  new Vec2(-44,0)],
					  40,
					  0.8,
					  100,
					  new Vec2(0, 0),
					  null,
					  Math.PI/1300);
		var t = setInterval(function() {
			g.clearRect(0,0,600,600);
			if (A.collidesWith(B)) {
				drawCollision();
				resolveCollision(A, B);
			}
			A.integrate(0.1);
			B.integrate(0.1);
			draw(A);
			draw(B);
		});
		addEventListener("keydown", function(){ clearInterval(t); })
	}

	function testPlatform() {
		var grav = new Vec2(0, 200.3);
		var p = [];
		p.push(new Body(new Vec2(canvas.width/2, 500),
						[new Vec2(-400, 30), new Vec2(400, 30),
						new Vec2(400, -30), new Vec2(-400, -30)],
						0, 0.2, 0));
		function addRectangle(x, y) {
			var width = 60;
			var mass = 100;
			p.push(new Body(new Vec2(x, y),
							[new Vec2(-width/2, width/2), new Vec2(width/2, width/2),
							new Vec2(width/2, -width/2), new Vec2(-width/2, -width/2)],
							mass, 0.7, mass*width*width,
							null,
							grav));
		}
		function addTriangle(x, y) {
			var a = 60;
			var mass = 100;
			p.push(new Body(new Vec2(x, y),
							[new Vec2(0, a), 
							new Vec2(a/2*Math.sqrt(3), -a/2),
							new Vec2(-a/2*Math.sqrt(3), -a/2)],
							mass, 0.7, mass*a*a,
							null,
							grav));
		}
		function addSphere(x, y) {
			var r = 50;
			var mass = 70;
			p.push(new Sphere(new Vec2(x,y), r, mass, 0.9, mass*r*r*2/5,
					null, grav));
		}
		var dt = 1/30;
		var ITERATION = 14;
		var t = setInterval(function() {
			g.clearRect(0,0,canvas.width,canvas.height);
			for (var iter = 0; iter < ITERATION; ++iter) {
				for (var i = 0; i < p.length; ++i) {
					for (var j = i+1; j < p.length; ++j) {
						if (p[i].collidesWith(p[j])) {
							resolveCollisionExtended(p[i], p[j]);
						}
					}
				}
				for (var i = 0; i < p.length; ++i) {
					p[i].integrate(dt/ITERATION);
				}
			}
			for (var i = 0; i < p.length; ++i) {
				draw(p[i]);
			}
		}, 1000/60);
		var key = 65;
		addEventListener("keydown", function(e){ 
			if (e.which == 32) {
				clearInterval(t);
				window.RES = p;
			}
			key = e.which;
		})
		canvas.addEventListener("mousedown", function(e) {
			var x = e.offsetX;
			var y =e.offsetY;
			if (key == 65) {
				addRectangle(x, y);
			} else if (key == 66) {
				addTriangle(x, y);
			} else if (key == 67) {
				addSphere(x, y);
			}
		});
	}
	</script>
</body>
</html>